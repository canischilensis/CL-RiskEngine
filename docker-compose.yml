version: '3.8'

services:
  # 游부 Servicio Principal: Motor de Riesgo
  risk-engine:
    container_name: cl-risk-engine-api
    build: 
      context: .
      dockerfile: Dockerfile
    
    # Mapeo de Puertos: (Host : Contenedor)
    # Podr치 acceder a la API en http://localhost:8000
    ports:
      - "8000:8000"
    
    # 游 Persistencia y Desarrollo (Volumes)
    volumes:
      # 1. C칩digo Fuente (Hot Reload):
      # Conecta su carpeta local 'src' con la del contenedor.
      # Cualquier cambio que guarde se refleja al instante.
      - ./src:/app/src
      
      # 2. Salida de Reportes:
      # Asegura que los TXT generados no mueran con el contenedor.
      - ./output:/app/output
      
      # 3. Configuraci칩n Local (Opcional):
      # Si usa un .env local, lo inyectamos aqu칤.
      - ./.env:/app/.env

    # Variables de Entorno
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    
    # Comando de Inicio (Override):
    # Sobrescribimos el CMD del Dockerfile para agregar "--reload"
    # Esto es vital para desarrollar r치pido.
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload

    # 游낀 Healthcheck (Monitoreo):
    # Docker preguntar치 cada 30s si la API sigue viva usando el endpoint que creamos.
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Pol칤tica de Reinicio:
    # Si falla por un error de c칩digo, intenta levantar de nuevo.
    restart: on-failure